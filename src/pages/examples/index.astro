---
import Layout from '../../layouts/Layout.astro';

// Dynamically import all example modules
const exampleModules = import.meta.glob('../../content/examples/*.ts', { eager: true });

// Build examples array from modules
const examples = Object.entries(exampleModules).map(([path, module]: [string, any]) => {
  const slug = path.split('/').pop()?.replace('.ts', '') || '';
  return {
    slug,
    title: module.meta.title,
    description: module.meta.description,
    topics: module.meta.topics || [],
    tags: module.meta.tags || [],
    image: `/examples/${slug}.png`,
  };
}).sort((a, b) => a.title.localeCompare(b.title));

// Collect all unique topics and tags
const allTopics = [...new Set(examples.flatMap(e => e.topics))].sort();
const allTags = [...new Set(examples.flatMap(e => e.tags))].sort();
---

<Layout title="Examples">
  <div class="header">
    <h1>Examples</h1>
    <p>Interactive simulations demonstrating Flocc's capabilities. Click any example to see the code and run it live.</p>
  </div>

  <div class="filters">
    <div class="filter-group">
      <label for="topics">Topics</label>
      <select id="topics">
        <option value="">All Topics</option>
        {allTopics.map(topic => (
          <option value={topic}>{topic}</option>
        ))}
      </select>
    </div>
    <div class="filter-group">
      <label for="tags">Tags</label>
      <select id="tags">
        <option value="">All Tags</option>
        {allTags.map(tag => (
          <option value={tag}>{tag}</option>
        ))}
      </select>
    </div>
  </div>

  <div class="grid" id="examples-grid">
    {examples.map((example) => (
      <a 
        href={`/examples/${example.slug}`} 
        class="card"
        data-topics={JSON.stringify(example.topics)}
        data-tags={JSON.stringify(example.tags)}
      >
        <div class="card-image">
          <img src={example.image} alt={example.title} loading="lazy" />
        </div>
        <div class="card-content">
          <h2>{example.title}</h2>
          <p>{example.description}</p>
          {(example.topics.length > 0 || example.tags.length > 0) && (
            <div class="card-meta">
              {example.topics.map(topic => (
                <span class="topic">{topic}</span>
              ))}
              {example.tags.map(tag => (
                <span class="tag">{tag}</span>
              ))}
            </div>
          )}
        </div>
      </a>
    ))}
  </div>
</Layout>

<script>
  const topicsSelect = document.getElementById('topics') as HTMLSelectElement;
  const tagsSelect = document.getElementById('tags') as HTMLSelectElement;
  const grid = document.getElementById('examples-grid');
  const cards = grid?.querySelectorAll('.card') as NodeListOf<HTMLAnchorElement>;

  function filterExamples() {
    const selectedTopic = topicsSelect.value;
    const selectedTag = tagsSelect.value;

    cards.forEach(card => {
      const topics = JSON.parse(card.dataset.topics || '[]');
      const tags = JSON.parse(card.dataset.tags || '[]');

      const matchesTopic = !selectedTopic || topics.includes(selectedTopic);
      const matchesTag = !selectedTag || tags.includes(selectedTag);

      if (matchesTopic && matchesTag) {
        card.style.display = 'flex';
      } else {
        card.style.display = 'none';
      }
    });
  }

  topicsSelect.addEventListener('change', filterExamples);
  tagsSelect.addEventListener('change', filterExamples);
</script>

<style>
  .header {
    margin-bottom: 2rem;
  }

  .header h1 {
    font-size: 2.5rem;
    margin-bottom: 0.5rem;
  }

  .header p {
    color: var(--color-text-muted);
    font-size: 1.1rem;
  }

  .filters {
    display: flex;
    gap: 1.5rem;
    margin-bottom: 2rem;
    flex-wrap: wrap;
  }

  .filter-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .filter-group label {
    font-size: 0.8rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--color-accent);
    font-weight: 600;
  }

  .filter-group select {
    padding: 0.5rem 1rem;
    font-size: 0.95rem;
    background: var(--color-surface);
    color: var(--color-text);
    border: 1px solid var(--color-border);
    border-radius: 6px;
    min-width: 180px;
    cursor: pointer;
  }

  .filter-group select:focus {
    outline: none;
    border-color: var(--color-accent);
  }

  .grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 1.5rem;
  }

  .card {
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: 12px;
    overflow: hidden;
    transition: all 0.2s;
    color: var(--color-text);
    display: flex;
    flex-direction: column;
  }

  .card:hover {
    border-color: var(--color-accent);
    transform: translateY(-2px);
    text-decoration: none;
  }

  .card-image {
    aspect-ratio: 16 / 10;
    background: var(--color-bg);
    overflow: hidden;
  }

  .card-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .card-content {
    padding: 1.25rem;
    flex: 1;
    display: flex;
    flex-direction: column;
  }

  .card-content h2 {
    font-size: 1.1rem;
    margin-bottom: 0.5rem;
    line-height: 1.3;
  }

  .card-content p {
    color: var(--color-text-muted);
    font-size: 0.85rem;
    flex: 1;
  }

  .card-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 0.4rem;
    margin-top: 0.75rem;
  }

  .card-meta .topic,
  .card-meta .tag {
    font-size: 0.7rem;
    padding: 0.2rem 0.5rem;
    border-radius: 4px;
  }

  .card-meta .topic {
    background: rgba(59, 130, 246, 0.2);
    color: var(--color-accent);
  }

  .card-meta .tag {
    background: var(--color-border);
    color: var(--color-text-muted);
  }
</style>
